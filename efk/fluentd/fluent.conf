<system>
  log_level info
  suppress_repeated_stacktrace true
  <log>
    format json
    time_format %Y-%m-%d %H:%M:%S %z
  </log>
</system>

# Forward input (for Docker logging driver)
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# HTTP input (for direct HTTP logs)
<source>
  @type http
  port 9880
  bind 0.0.0.0
  body_size_limit 32m
  keepalive_timeout 10s
</source>

# Monitor agent (for health checks)
<source>
  @type monitor_agent
  bind 0.0.0.0
  port 24220
</source>

# Add hostname only
<filter **>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
  </record>
</filter>

# Main output to Elasticsearch
<match **>
  @type elasticsearch
  host es01
  port 9200
  scheme https
  ssl_verify false
  ca_file /fluentd/certs/ca/ca.crt
  user elastic
  password "#{ENV['ELASTIC_PASSWORD']}"

  # ES 8.x compatibility settings
  suppress_type_name true

  # Index settings
  index_name fluentd-logs

  # Disable debug logging for this output
  @log_level warn

  # Performance settings
  request_timeout 120s
  reload_connections false
  reconnect_on_error true
  reload_on_failure true

  # Simple buffering
  <buffer>
    @type file
    path /fluentd/log/buffer
    flush_mode interval
    flush_interval 10s
    chunk_limit_size 10MB
    queue_limit_length 32
    retry_max_interval 30
    retry_forever true
    overflow_action block
  </buffer>

  # Error handling
  <secondary>
    @type file
    path /fluentd/log/failed_records
    compress gzip
  </secondary>
</match>

